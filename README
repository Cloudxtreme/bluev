Source code and electronic designs are licensed under the GNU General Public License Version 3

This is a Valentine V1 ESP interface based on the ATtiny4313 running at 20Mhz
(Note: The ATtiny2313 should also work as I'm not using more than half the RAM or Flash)

The hard part about implementing ESP packet sends is that the UART needs to be switched in and out, and the bytes have to be paced according to specific timing.  This is designed to do that hard, subtle, fiddly timing stuff.  Just send it a correct frame (from SOF to EOF with valid 3rd party device ID and checksum) and it does the rest.

Currently, only the checksum version of ESP is supported.  Upgrade your V1.

Baud is 57600 as per spec.

See Downloads for schematic or board info when available.

The pins on the ATtiny4313 are (PDIP/SOIC)

1 Reset (nc/ISP/dW)
2 RXD PD0 - from Bluetooth Module or serial transmit
3 TXD PD1 - to pin 11 ICP1 and V1 Data Line  (and to bluetooth/serial receive via diode)
4 XTAL1 - to 20Mhz resonator or crystal
5 XTAL2 - to 20Mhz resonator or crystal
6 INT0 PD2 nc
7 INT1 PD3 nc
8 PD4 nc
9 PD5 nc
10 GND - to ground

20 VCC - to 5v
19 PB7 nc SCK for ISP
18 PB6 nc MISO for ISP
17 PB5 nc MOSI for ISP
16 PB4 nc
15 PB3 nc
14 PB2 nc
13 PB1 nc
12 PB0 nc
11 ICP1 PD6 - to pin 3 TXD and V1 Data Line (and to bluetooth/serial receive via diode)

The ICP1 is used to create a 57600 baud software UART and to do timing to do the proper framing.

The data stream from all devices included echoed data from the interface will directly go out via serial (breaks may cause nulls in the data).  Typically to bluetooth.

Data from the (bluetooth) serial interface will be stored and validated (it has to be a valid ESP message with IDs 3, 4, or 5) and sent out at the correct time for the device ID.

$ echo -ne "\xaa\xda\xe4\x32\x01\x9b\xab" >/dev/ttyUSB0
Display goes off
$ echo -ne "\xaa\xda\xe4\x33\x01\x9c\xab" >/dev/ttyUSB0
Display goes on

TODO:

TS Holdoff (infDisplayData Aux0 (stream byte[10]) bit 1 (0x02) says if accs are allowed to send)
Do checksumming of BT incoming as the data is received (avoid overly long interrupt at end)
Better sync / collision avoidance with other things on the bus - stop bit routine delays start of slice?
v1send - add option to ask for version for display, audio, savvy; (factory reset?)
v1send - write user bytes, sweep stuff???
